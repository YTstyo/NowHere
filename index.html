<!DOCTYPE html>
<html lang="en" class="h-full dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NowHere - Shared Moments in Real-Time</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { 
            getFirestore, collection, doc, setDoc, getDoc, getDocs, 
            addDoc, deleteDoc, updateDoc, query, where, orderBy, 
            limit, serverTimestamp, onSnapshot, Timestamp 
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBUe5_G2eA6_MSUQfrEzlBfgQH8wVvTJbY",
            authDomain: "fir-e7510.firebaseapp.com",
            projectId: "fir-e7510",
            storageBucket: "fir-e7510.appspot.com",
            messagingSenderId: "194099392363",
            appId: "1:194099392363:web:ac4260c4da70dbb39ba62e",
            measurementId: "G-NDQCKCN1QB"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            
            let isOnline = navigator.onLine;
            const connectionStatus = document.getElementById('connection-status');
            
            function updateUIConnectionStatus() {
                if (!connectionStatus) return;
                
                if (isOnline) {
                    connectionStatus.innerHTML = '<i class="fas fa-check text-green-400"></i> Connected';
                    setTimeout(() => {
                        connectionStatus.classList.add('opacity-0');
                    }, 2000);
                } else {
                    connectionStatus.classList.remove('opacity-0');
                    connectionStatus.innerHTML = '<i class="fas fa-wifi-slash text-red-400"></i> Offline';
                }
            }
            
            window.addEventListener('online', () => {
                isOnline = true;
                updateUIConnectionStatus();
                document.dispatchEvent(new Event('refreshData'));
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateUIConnectionStatus();
            });
            
            updateUIConnectionStatus();
            
            async function safeSetDoc(docRef, data) {
                try {
                    return await setDoc(docRef, data);
                } catch (error) {
                    console.error("Firestore setDoc error:", error);
                    throw error;
                }
            }
            
            async function safeGetDoc(docRef) {
                try {
                    return await getDoc(docRef);
                } catch (error) {
                    console.error("Firestore getDoc error:", error);
                    throw error;
                }
            }
            
            async function safeGetDocs(collectionRef) {
                try {
                    return await getDocs(collectionRef);
                } catch (error) {
                    console.error("Firestore getDocs error:", error);
                    throw error;
                }
            }
            
            async function safeAddDoc(collectionRef, data) {
                try {
                    return await addDoc(collectionRef, data);
                } catch (error) {
                    console.error("Firestore addDoc error:", error);
                    throw error;
                }
            }
            
            async function safeUpdateDoc(docRef, data) {
                try {
                    return await updateDoc(docRef, data);
                } catch (error) {
                    console.error("Firestore updateDoc error:", error);
                    throw error;
                }
            }
            
            async function safeDeleteDoc(docRef) {
                try {
                    return await deleteDoc(docRef);
                } catch (error) {
                    console.error("Firestore deleteDoc error:", error);
                    throw error;
                }
            }
            
            const clientId = Date.now() + Math.random().toString(36).substr(2, 9);
            const userId = 'user-' + clientId;
            
            window.firebaseApp = {
                db,
                setDoc: safeSetDoc,
                getDoc: safeGetDoc,
                getDocs: safeGetDocs,
                addDoc: safeAddDoc,
                updateDoc: safeUpdateDoc,
                deleteDoc: safeDeleteDoc,
                serverTimestamp: () => serverTimestamp(),
                isOnline: () => isOnline,
                userId,
                collection,
                doc,
                onSnapshot,
                query,
                where
            };
            
            console.log("Firebase initialized with Firestore");
            document.dispatchEvent(new Event('firebaseReady'));
            
        } catch (error) {
            console.error("Firebase initialization error:", error);
            
            const connectionStatus = document.getElementById('connection-status');
            if (connectionStatus) {
                connectionStatus.classList.remove('opacity-0');
                connectionStatus.innerHTML = '<i class="fas fa-exclamation-triangle text-red-400"></i> Connection Error';
                
                const reconnectBtn = document.createElement('button');
                reconnectBtn.id = 'reconnect-button';
                reconnectBtn.className = 'ml-2 px-2 py-1 bg-blue-500 text-white text-xs rounded';
                reconnectBtn.textContent = 'Reconnect';
                reconnectBtn.onclick = () => window.location.reload();
                connectionStatus.appendChild(reconnectBtn);
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --bg-dark: #0f172a;
            --bg-darker: #020617;
            --text-light: #f8fafc;
            --text-dim: #94a3b8;
        }
        
        .leaflet-popup-content-wrapper {
            background: transparent;
            box-shadow: none;
            border: none;
        }
        
        .leaflet-popup-tip-container {
            display: none;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            color: var(--text-light);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
            width: 100vw;
            height: 100vh;
            flex: 1;
        }
        
        .moment-marker {
            background: rgba(99, 102, 241, 0.9);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .moment-marker:hover {
            transform: scale(1.3);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.7);
        }
                
        .moment-card {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            max-width: 500px;
            min-height: 420px; 
            z-index: 1000;
            border: none;
        }

        .moment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .emoji-picker {
            position: absolute;
            bottom: 60px;
            right: 0;
            width: 350px;
            background: var(--bg-dark);
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            z-index: 100;
            padding: 12px;
            display: none;
            border: none;
        }
        
        .emoji-picker.show {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }
        
        .emoji-category {
            margin-bottom: 12px;
        }
        
        .emoji-category-title {
            font-size: 12px;
            color: var(--text-dim);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 6px;
        }
        
        .emoji-option {
            font-size: 24px;
            cursor: pointer;
            text-align: center;
            padding: 4px;
            border-radius: 6px;
            transition: all 0.2s;
            color: white;
        }
        
        .emoji-option:hover {
            background: rgba(99, 102, 241, 0.2);
            transform: scale(1.2);
        }
        
        .reaction-bubble {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 20px;
            padding: 2px 8px;
            font-size: 12px;
            margin-right: 4px;
            transition: all 0.2s;
            color: white;
            border: none;
        }
        
        .reaction-bubble:hover {
            transform: scale(1.1);
            background: rgba(99, 102, 241, 0.3);
        }
        
        .hidden-message {
            filter: blur(6px);
            user-select: none;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            border: none;
        }
        
        .hidden-message:hover {
            filter: blur(4px);
        }
        
        .hidden-message.revealed {
            filter: none;
        }
        
        .overlay {
            position: absolute;
            z-index: 100;
            pointer-events: none;
        }
        
        .overlay * {
            pointer-events: auto;
        }
        
        .top-overlay {
            top: 0;
            left: 0;
            right: 0;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .bottom-overlay {
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem;
            display: flex;
            justify-content: center;
        }
        
        .right-overlay {
            top: 0;
            right: 0;
            bottom: 0;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-end;
            gap: 1rem;
        }
        
        .location-chip {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 20px;
            padding: 4px 10px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            color: white;
            border: none;
        }
        
        .user-location {
            background: rgba(16, 185, 129, 0.9);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .user-location:hover {
            transform: scale(1.3);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.7);
        }
        
        .moment-popup {
            background: rgba(15, 23, 42, 0.95);
            border-radius: 12px;
            padding: 1rem;
            max-width: 300px;
            border: none;
        }
        
        .map-controls {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 8px;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .map-control-button {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            background: rgba(30, 41, 59, 0.8);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .map-control-button:hover {
            background: rgba(51, 65, 85, 0.8);
            transform: scale(1.1);
        }
        
        .floating-form {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            right: 1rem;
            max-width: 500px;
            margin: 0 auto;
            z-index: 1000;
            pointer-events: auto;
        }
        
        .reply-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .reply {
            font-size: 12px;
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 8px;
            color: white;
            border: none;
        }
        
        .reply-form {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .reply-input {
            flex-grow: 1;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 8px;
            padding: 8px;
            font-size: 12px;
            color: white;
            border: none;
        }
        
        .reply-button {
            background: rgba(99, 102, 241, 0.8);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0 12px;
            cursor: pointer;
        }
        
        @media (min-width: 768px) {
            .floating-form {
                left: 2rem;
                right: auto;
            }
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .toast {
            position: fixed;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 41, 59, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
        }

        /* Dark mode styles */
        .dark {
            background-color: #0f172a;
            color: #f8fafc;
        }

        .light {
            background-color: #f8fafc;
            color: #0f172a;
        }

        .dark .map-control-button {
            background: rgba(30, 41, 59, 0.8);
            color: white;
        }

        .light .map-control-button {
            background: rgba(226, 232, 240, 0.8);
            color: #0f172a;
        }

        .dark .moment-card {
            background: rgba(15, 23, 42, 0.95);
        }

        .light .moment-card {
            background: rgba(248, 250, 252, 0.95);
        }

        .dark .moment-popup {
            background: rgba(15, 23, 42, 0.95);
        }

        .light .moment-popup {
            background: rgba(248, 250, 252, 0.95);
        }

        .dark .reply-input {
            background: rgba(30, 41, 59, 0.8);
            color: white;
        }

        .light .reply-input {
            background: rgba(226, 232, 240, 0.8);
            color: #0f172a;
        }

        .share-moment-button {
            width: 100%;
            padding: 12px 24px; 
            font-size: 1rem;
            background-image: linear-gradient(to right, #2563eb, #7c3aed); 
            color: #fff;
            border-radius: 0.5rem;
            font-weight: 500; 
            border: none;
            margin-top: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
            outline: none;
        }

        .share-moment-button:hover {
            background-image: linear-gradient(to right, #3b82f6, #9333ea); 
        }

        .share-moment-button:focus {
            box-shadow: 0 0 0 2px #3b82f6, 0 0 0 4px #1e293b; 
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .feed-panel {
            position: absolute;
            top: 64px;
            left: 0;
            bottom: 0;
            width: 350px;
            background: rgba(15, 23, 42, 0.97);
            backdrop-filter: blur(15px);
            z-index: 50;
            padding: 1.25rem;
            overflow-y: auto;
            transform: translateX(-100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.3);
            border-right: 1px solid rgba(255, 255, 255, 0.08);
            margin-top: 20px; /* Add space for the header text */
        }

        .feed-panel.active {
            transform: translateX(0);
        }

        .feed-item {
            background: rgba(30, 41, 59, 0.8);
            padding: 1.25rem;
            margin-bottom: 1.25rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .feed-item:hover {
            background: rgba(30, 41, 59, 0.95);
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .feed-toggle {
            position: absolute;
            top: 80px;
            right: 20px;
            z-index: 60;
            width: 46px;
            height: 46px;
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            box-shadow: 0 3px 12px rgba(79, 70, 229, 0.4);
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.15);
        }

        .feed-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(79, 70, 229, 0.6);
        }

        .feed-panel::-webkit-scrollbar {
            width: 6px;
        }

        .feed-panel::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
        }

        .feed-panel::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.5);
            border-radius: 10px;
        }

        /* Ensure app title and tagline stay above feed panel */
        .overlay.top-overlay {
            z-index: 55; /* Higher than feed-panel */
        }

        .dark {
            background-color: #0f172a;
            color: #f8fafc;
        }

        .light {
            background-color: #f8fafc;
            color: #0f172a;
        }

        .dark .map-control-button {
            background: rgba(30, 41, 59, 0.8);
            color: white;
        }

        .light .map-control-button {
            background: rgba(226, 232, 240, 0.8);
            color: #0f172a;
        }

        .dark .moment-card {
            background: rgba(15, 23, 42, 0.95);
        }

        .light .moment-card {
            background: rgba(248, 250, 252, 0.95);
        }

        .dark .moment-popup {
            background: rgba(15, 23, 42, 0.95);
        }

        .light .moment-popup {
            background: rgba(248, 250, 252, 0.95);
        }

        .dark .reply-input {
            background: rgba(30, 41, 59, 0.8);
            color: white;
        }

        .light .reply-input {
            background: rgba(226, 232, 240, 0.8);
            color: #0f172a;
        }

        .share-moment-button {
            width: 100%;
            padding: 12px 24px; 
            font-size: 1rem;
            background-image: linear-gradient(to right, #2563eb, #7c3aed); 
            color: #fff;
            border-radius: 0.5rem;
            font-weight: 500; 
            border: none;
            margin-top: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
            outline: none;
        }

        .share-moment-button:hover {
            background-image: linear-gradient(to right, #3b82f6, #9333ea); 
        }

        .share-moment-button:focus {
            box-shadow: 0 0 0 2px #3b82f6, 0 0 0 4px #1e293b; 
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .feed-panel {
            position: absolute;
            top: 64px;
            left: 0;
            bottom: 0;
            width: 350px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            z-index: 50;
            padding: 1rem;
            overflow-y: auto;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.2);
        }
        
        .feed-panel.active {
            transform: translateX(0);
        }
        
        .feed-item {
            background: rgba(30, 41, 59, 0.7);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .feed-item:hover {
            background: rgba(30, 41, 59, 0.9);
            transform: translateY(-2px);
        }
        
        .feed-toggle {
            position: absolute;
            top: 80px;
            right: 20px;
            z-index: 60;
            width: 40px;
            height: 40px;
            background: rgba(99, 102, 241, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .feed-panel {
            left: 0; 
            transform: translateX(-100%);
        }
    </style>
</head>
<body class="min-h-full overflow-hidden">
    <div id="map" class="map-container"></div>
    
    <div class="feed-panel" id="feed-panel">
        <h2 class="text-xl font-bold mb-4">Recent Moments</h2>
        <div class="feed-items" id="feed-items">
            <!-- Feed items will be added here dynamically -->
        </div>
    </div>
    
    <div class="feed-toggle" id="feed-toggle" title="Toggle Feed">
        <i class="fas fa-list"></i>
    </div>
    
    <div class="overlay top-overlay">
        <div>
            <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-500 to-purple-600 bg-clip-text text-transparent">NowHere</h1>
            <p class="text-xs opacity-75">"Right now, somewhere. A moment, fleeting, shared."</p>
        </div>
        <div class="flex space-x-2">
            <div id="connection-status" class="text-xs flex items-center px-3 py-1 bg-gray-800 rounded-lg transition-opacity duration-500">
                <i class="fas fa-spinner fa-spin text-blue-400 mr-1"></i> Connecting...
            </div>
            <button id="theme-toggle" class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-800 hover:bg-gray-700 transition">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </div>
    
    <div class="overlay right-overlay">
        <div class="map-controls">
            <button id="zoom-in" class="map-control-button" title="Zoom In">
                <i class="fas fa-plus"></i>
            </button>
            <button id="zoom-out" class="map-control-button" title="Zoom Out">
                <i class="fas fa-minus"></i>
            </button>
            <button id="locate-me" class="map-control-button" title="Locate Me">
                <i class="fas fa-location-arrow"></i>
            </button>
        </div>
        <button id="toggle-form" class="map-control-button bg-blue-600 hover:bg-blue-500 w-12 h-12 flex items-center justify-center" title="Share Moment">
            <i class="fas fa-plus text-lg"></i>
        </button>
    </div>
    
    <div class="floating-form hidden">
        <div class="moment-card rounded-xl shadow-md p-6 mb-8 slide-up">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-medium">Share your moment</h2>
                <button id="close-form" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="moment-form" class="space-y-4" novalidate>
                <div>
                    <textarea 
                        id="message" 
                        placeholder="What's happening right now?" 
                        class="w-full px-4 py-3 text-base bg-gray-800 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                        rows="5"
                        maxlength="280"
                        required
                    ></textarea>
                    <div id="message-error" class="text-red-500 text-sm mt-1 hidden">Please share what's happening right now</div>
                    <div class="flex justify-between items-center mt-2">
                        <div class="text-sm text-gray-400">
                            <span id="char-count">0</span>/280
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="hide-message" class="rounded border-gray-600 bg-gray-700">
                            <label for="hide-message" class="text-sm text-gray-400">Hide message</label>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="relative flex-grow">
                        <input 
                            type="text" 
                            id="location" 
                            placeholder="Where are you? (city or place)" 
                            class="w-full px-4 py-3 text-base bg-gray-800 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required
                        >
                        <div id="location-error" class="text-red-500 text-sm mt-1 hidden">Please enter your location</div>
                        <div id="detected-location" class="text-sm text-gray-400 mt-1">
                            <span>Detected: </span>
                            <span id="detected-location-text"></span>
                            <button id="use-detected-location" class="text-blue-400 ml-1 hover:underline">Use</button>
                        </div>
                    </div>
                    
                    <div class="relative">
                        <button 
                            type="button" 
                            id="mood-toggle" 
                            class="w-12 h-12 flex items-center justify-center rounded-full bg-gray-800 hover:bg-gray-700 transition"
                        >
                            <span id="selected-mood" class="text-3xl">😐</span>
                        </button>
                        <div id="emoji-picker" class="emoji-picker">
                            <div class="emoji-category">
                                <div class="emoji-category-title">Smileys</div>
                                <div class="emoji-grid">
                                    <div class="emoji-option" data-emoji="😊">😊</div>
                                    <div class="emoji-option" data-emoji="😄">😄</div>
                                    <div class="emoji-option" data-emoji="😍">😍</div>
                                    <div class="emoji-option" data-emoji="🥰">🥰</div>
                                    <div class="emoji-option" data-emoji="😎">😎</div>
                                    <div class="emoji-option" data-emoji="😢">😢</div>
                                    <div class="emoji-option" data-emoji="😡">😡</div>
                                    <div class="emoji-option" data-emoji="😴">😴</div>
                                </div>
                            </div>
                            <div class="emoji-category">
                                <div class="emoji-category-title">Activities</div>
                                <div class="emoji-grid">
                                    <div class="emoji-option" data-emoji="⚽">⚽</div>
                                    <div class="emoji-option" data-emoji="🎮">🎮</div>
                                    <div class="emoji-option" data-emoji="🎨">🎨</div>
                                    <div class="emoji-option" data-emoji="🎵">🎵</div>
                                    <div class="emoji-option" data-emoji="📚">📚</div>
                                    <div class="emoji-option" data-emoji="🍳">🍳</div>
                                    <div class="emoji-option" data-emoji="🚴">🚴</div>
                                    <div class="emoji-option" data-emoji="🎭">🎭</div>
                                </div>
                            </div>
                            <div class="emoji-category">
                                <div class="emoji-category-title">Nature</div>
                                <div class="emoji-grid">
                                    <div class="emoji-option" data-emoji="🌞">🌞</div>
                                    <div class="emoji-option" data-emoji="🌧️">🌧️</div>
                                    <div class="emoji-option" data-emoji="🌲">🌲</div>
                                    <div class="emoji-option" data-emoji="🌊">🌊</div>
                                    <div class="emoji-option" data-emoji="🐦">🐦</div>
                                    <div class="emoji-option" data-emoji="🐱">🐱</div>
                                    <div class="emoji-option" data-emoji="🌸">🌸</div>
                                    <div class="emoji-option" data-emoji="🍂">🍂</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                                
                <button type="submit" class="share-moment-button">
                    <i class="fas fa-paper-plane" style="margin-right: 0.5rem;"></i>Share Moment
                </button>
            </form>
        </div>
    </div>

    <script>
        // Add validation for the form
        document.getElementById('moment-form').addEventListener('submit', function(e) {
            let isValid = true;
            const messageInput = document.getElementById('message');
            const locationInput = document.getElementById('location');
            const messageError = document.getElementById('message-error');
            const locationError = document.getElementById('location-error');
            
            // Validate message
            if (!messageInput.value.trim()) {
                messageError.classList.remove('hidden');
                messageInput.classList.add('border', 'border-red-500');
                isValid = false;
            } else {
                messageError.classList.add('hidden');
                messageInput.classList.remove('border', 'border-red-500');
            }
            
            // Validate location
            if (!locationInput.value.trim()) {
                locationError.classList.remove('hidden');
                locationInput.classList.add('border', 'border-red-500');
                isValid = false;
            } else {
                locationError.classList.add('hidden');
                locationInput.classList.remove('border', 'border-red-500');
            }
            
            if (!isValid) {
                e.preventDefault();
            }
        });
        
        // Clear errors when inputs change
        document.getElementById('message').addEventListener('input', function() {
            if (this.value.trim()) {
                document.getElementById('message-error').classList.add('hidden');
                this.classList.remove('border', 'border-red-500');
            }
        });
        
        document.getElementById('location').addEventListener('input', function() {
            if (this.value.trim()) {
                document.getElementById('location-error').classList.add('hidden');
                this.classList.remove('border', 'border-red-500');
            }
        });
    </script>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const lightTile =  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
            attribution: '',
            subdomains: 'abcd',
            maxZoom: 19,
            noWrap: false
        });

        const darkTile = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '',
            subdomains: 'abcd',
            maxZoom: 19,
            noWrap: false
        });
        
        let isDarkMode = true;
        const momentForm = document.getElementById('moment-form');
        const messageInput = document.getElementById('message');
        const locationInput = document.getElementById('location');
        const charCount = document.getElementById('char-count');
        const moodToggle = document.getElementById('mood-toggle');
        const emojiPicker = document.getElementById('emoji-picker');
        const hideMessageCheckbox = document.getElementById('hide-message');
        const themeToggle = document.getElementById('theme-toggle');
        const detectedLocationDiv = document.getElementById('detected-location');
        const detectedLocationText = document.getElementById('detected-location-text');
        const useDetectedLocationBtn = document.getElementById('use-detected-location');
        const toggleFormButton = document.getElementById('toggle-form');
        const closeFormButton = document.getElementById('close-form');
        const floatingForm = document.querySelector('.floating-form');
        const zoomInButton = document.getElementById('zoom-in');
        const zoomOutButton = document.getElementById('zoom-out');
        const locateMeButton = document.getElementById('locate-me');
        const feedPanel = document.getElementById('feed-panel');
        const feedToggle = document.getElementById('feed-toggle');
        const feedItems = document.getElementById('feed-items');
        const mapContainer = document.getElementById('map');
        
        let moments = [];
        let map;
        let markers = [];
        let userMarker;
        let userId = 'user-' + Math.random().toString(36).substr(2, 4);
        let revealedMessages = JSON.parse(localStorage.getItem('revealedMessages') || '{}');
        let userLocation = null;
        let userGeoLocation = null;
        let isFormOpen = false;
        let isFeedOpen = false;
        // Track user reactions
        let userReactions = JSON.parse(localStorage.getItem('userReactions') || '{}');
        
        function initFirebase() {
            if (!window.firebaseApp) {
                console.error("Firebase not initialized");
                setTimeout(initFirebase, 500);
                return;
            }
            
            const fb = window.firebaseApp;
            window.db = fb.db;
            window.collection = fb.collection;
            window.doc = fb.doc;
            window.setDoc = fb.setDoc;
            window.getDoc = fb.getDoc;
            window.getDocs = fb.getDocs;
            window.addDoc = fb.addDoc;
            window.updateDoc = fb.updateDoc;
            window.deleteDoc = fb.deleteDoc;
            window.onSnapshot = fb.onSnapshot;
            window.query = fb.query;
            window.where = fb.where;
            userId = fb.userId;
            
            window.momentsRef = collection(db, 'moments');
            
            loadMoments();
            cleanupOldMoments();
            setInterval(cleanupOldMoments, 60 * 60 * 1000);
            
            setTimeout(() => {
                getDocs(momentsRef).then((snapshot) => {
                    if (snapshot.empty) {
                        generateDemoMoments();
                    }
                }).catch(error => {
                    console.error("Error checking for existing moments:", error);
                });
            }, 1000);
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initFirebase);
        } else {
            document.addEventListener('firebaseReady', initFirebase);
            initFirebase();
        }
        
        function initMap() {
            // Initialize the map with constraints
            map = L.map('map', {
                zoomControl: false,
                doubleClickZoom: false,
                closePopupOnClick: false,
                minZoom: 3, // Increase the minimum zoom level to prevent white borders
                maxZoom: 18,
                maxBounds: [
                    [-90, -180],
                    [90, 180]
                ],
                maxBoundsViscosity: 1.0,
                worldCopyJump: true,
                layers: [darkTile] // Start with dark theme
            }).setView([0, 0], 3); // Also start at a higher zoom level

            // Make sure the map fills the viewport
            function updateMapSize() {
                map.invalidateSize();
            }
            
            // Call on init and when window resizes
            updateMapSize();
            window.addEventListener('resize', updateMapSize);

            // Ensure map tiles fully cover the viewport
            map.on('resize', function() {
                map.setView(map.getCenter());
            });

            // Add event listeners for viewport changes
            document.addEventListener('visibilitychange', updateMapSize);
            window.addEventListener('orientationchange', updateMapSize);
            
            // Geolocation logic
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const offsetLat = (Math.random() * 0.02) - 0.01;
                        const offsetLng = (Math.random() * 0.02) - 0.01;

                        userGeoLocation = {
                            lat: position.coords.latitude + offsetLat,
                            lng: position.coords.longitude + offsetLng
                        };

                        if (userMarker) {
                            map.removeLayer(userMarker);
                        }

                        userMarker = L.marker([userGeoLocation.lat, userGeoLocation.lng], {
                            icon: L.divIcon({
                                className: 'user-location',
                                html: '<i class="fas fa-user"></i>',
                                iconSize: [24, 24]
                            })
                        }).addTo(map);

                        map.setView([userGeoLocation.lat, userGeoLocation.lng], 13);

                        getLocationName(position.coords.latitude, position.coords.longitude).then(name => {
                            if (name && detectedLocationText && detectedLocationDiv) {
                                detectedLocationText.textContent = name;
                                detectedLocationDiv.classList.remove('hidden');
                            }
                        });
                    },
                    (error) => {
                        console.log("Geolocation error:", error);
                        getUserLocation();
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            } else {
                getUserLocation();
            }

            map.on('click', () => {
                map.closePopup();
            });
        }
        
        async function getUserLocation() {
            try {
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                const userIp = ipData.ip;
                
                const locationResponse = await fetch(`https://ipapi.co/${userIp}/json/`);
                const locationData = await locationResponse.json();
                
                if (locationData.city && locationData.country_name) {
                    userLocation = {
                        city: locationData.city,
                        country: locationData.country_name,
                        coords: {
                            lat: parseFloat(locationData.latitude),
                            lng: parseFloat(locationData.longitude)
                        }
                    };
                    
                    if (map && userLocation.coords) {
                        map.setView([userLocation.coords.lat, userLocation.coords.lng], 10);
                        
                        if (detectedLocationText && detectedLocationDiv) {
                            detectedLocationText.textContent = `${userLocation.city}, ${userLocation.country}`;
                            detectedLocationDiv.classList.remove('hidden');
                        }
                    }
                }
            } catch (error) {
                console.error("Error getting user location:", error);
            }
        }
        
        async function getLocationName(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await response.json();
                
                if (data.address) {
                    const city = data.address.city || data.address.town || data.address.village;
                    const country = data.address.country;
                    
                    if (city && country) {
                        return `${city}, ${country}`;
                    }
                }
                
                return null;
            } catch (error) {
                console.error("Error getting location name:", error);
                return null;
            }
        }
        
        if (useDetectedLocationBtn) {
            useDetectedLocationBtn.addEventListener('click', () => {
                if (userLocation && locationInput) {
                    locationInput.value = `${userLocation.city}, ${userLocation.country}`;
                    if (detectedLocationDiv) {
                        detectedLocationDiv.classList.add('hidden');
                    }
                }
            });
        }
        
        function updateMapMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            moments.forEach(moment => {
                if (moment.coords) {
                    const marker = L.marker([moment.coords.lat, moment.coords.lng], {
                        icon: L.divIcon({
                            className: 'moment-marker',
                            html: moment.mood,
                            iconSize: [32, 32]
                        })
                    }).addTo(map);
                    
                    const popupContent = document.createElement('div');
                    popupContent.className = 'moment-popup';
                    
                    const isHidden = moment.isHidden && !revealedMessages[moment.id];
                    
                    popupContent.innerHTML = `
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center space-x-3">
                                <span class="text-2xl">${moment.mood}</span>
                                <span class="text-sm text-gray-400">${getTimeAgo(moment.timestamp)}</span>
                            </div>
                            ${moment.location ? `<span class="location-chip"><i class="fas fa-map-marker-alt mr-1"></i>${moment.location}</span>` : ''}
                        </div>
                        <div class="mb-3">
                            <div class="${isHidden ? 'hidden-message' : ''} text-white">
                                ${isHidden ? 'This message is hidden. Click to reveal.' : moment.message}
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex flex-wrap gap-1">
                                ${Object.entries(moment.reactions || {}).map(([emoji, count]) => `
                                    <button class="reaction-bubble moment-react ${userReactions[moment.id]?.includes(emoji) ? 'bg-blue-700' : ''}" data-moment-id="${moment.id}" data-reaction="${emoji}">
                                        ${emoji} ${count}
                                    </button>
                                `).join('')}
                                <button class="moment-react-add text-gray-400 hover:text-blue-400 transition px-2 py-1 rounded-full text-sm">
                                    <i class="far fa-smile"></i>
                                </button>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="moment-hide text-xs text-gray-400 hover:text-gray-300 transition" data-moment-id="${moment.id}">
                                    <i class="far ${isHidden ? 'fa-eye' : 'fa-eye-slash'}"></i>
                                </button>
                                ${moment.userId === userId ? `
                                    <button class="moment-delete text-xs text-gray-400 hover:text-red-400 transition" data-moment-id="${moment.id}">
                                        <i class="far fa-trash-alt"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="reply-section">
                            <div class="replies-container" id="replies-${moment.id}">
                                ${moment.replies ? moment.replies.map(reply => `
                                    <div class="reply">
                                        <div class="flex items-center justify-between">
                                            <span class="font-medium">${reply.userId}</span>
                                            <span class="text-gray-400 text-xs">${getTimeAgo(reply.timestamp)}</span>
                                        </div>
                                        <div>${reply.message}</div>
                                    </div>
                                `).join('') : ''}
                            </div>
                            <div class="reply-form">
                                <input type="text" class="reply-input" placeholder="Add a reply..." data-moment-id="${moment.id}">
                                <button class="reply-button" data-moment-id="${moment.id}">Reply</button>
                            </div>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent, {
                        maxWidth: 350,
                        className: 'moment-popup-container',
                        autoClose: false, // Prevent auto-closing
                        closeOnClick: false // Don't close when clicking elsewhere on the map
                    });
                    
                    popupContent.querySelectorAll('.hidden-message').forEach(el => {
                        el.addEventListener('click', (e) => {
                            e.stopPropagation(); // Prevent event propagation
                            const momentId = el.closest('[data-moment-id]')?.getAttribute('data-moment-id') || 
                                            el.closest('.moment-popup')?.querySelector('[data-moment-id]')?.getAttribute('data-moment-id');
                            
                            if (momentId) {
                                revealedMessages[momentId] = true;
                                localStorage.setItem('revealedMessages', JSON.stringify(revealedMessages));
                                
                                const moment = moments.find(m => m.id === momentId);
                                if (moment) {
                                    el.classList.remove('hidden-message');
                                    el.textContent = moment.message;
                                    
                                    const hideButton = popupContent.querySelector('.moment-hide');
                                    if (hideButton) {
                                        hideButton.innerHTML = '<i class="far fa-eye-slash"></i>';
                                    }
                                }
                            }
                        });
                    });
                    
                    popupContent.querySelectorAll('.moment-react').forEach(button => {
                        button.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const momentId = button.getAttribute('data-moment-id');
                            const reaction = button.getAttribute('data-reaction');
                            
                            // Check if user has already used this reaction for this moment
                            if (!userReactions[momentId]) {
                                userReactions[momentId] = [];
                            }
                            
                            if (userReactions[momentId].includes(reaction)) {
                                showToast(`You've already used this reaction`);
                                return;
                            }
                            
                            if (reaction) {
                                addReaction(momentId, reaction);
                                // Track this reaction for this user
                                userReactions[momentId].push(reaction);
                                localStorage.setItem('userReactions', JSON.stringify(userReactions));
                                
                                // Add visual feedback by changing button background
                                button.classList.add('bg-blue-700');
                                
                                showToast(`You reacted with ${reaction}`);
                            }
                        });
                    });
                    
                    popupContent.querySelectorAll('.moment-react-add').forEach(button => {
                        button.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const momentId = e.currentTarget.closest('[data-moment-id]')?.getAttribute('data-moment-id') || 
                                           e.currentTarget.parentElement.parentElement.querySelector('[data-moment-id]')?.getAttribute('data-moment-id');
                            
                            if (!momentId) return;
                            
                            const picker = document.createElement('div');
                            picker.className = 'absolute bg-gray-800 border border-gray-700 rounded-full p-2 shadow-lg flex space-x-1 z-10';
                            picker.style.top = '-40px';
                            picker.style.left = '0';
                            
                            const emojis = ['❤️', '😂', '😮', '😢', '👍', '👎', '🔥', '🎉'];
                            
                            // Filter out emojis user has already used for this moment
                            const usedEmojis = userReactions[momentId] || [];
                            
                            emojis.forEach(emoji => {
                                const emojiBtn = document.createElement('button');
                                emojiBtn.className = 'text-xl hover:scale-125 transition-transform';
                                if (usedEmojis.includes(emoji)) {
                                    emojiBtn.classList.add('opacity-50');
                                    emojiBtn.title = 'Already used';
                                }
                                emojiBtn.textContent = emoji;
                                emojiBtn.addEventListener('click', (event) => {
                                    // Only add reaction if not used already
                                    if (!usedEmojis.includes(emoji)) {
                                        addReaction(momentId, emoji);
                                        
                                        // Track this reaction
                                        if (!userReactions[momentId]) {
                                            userReactions[momentId] = [];
                                        }
                                        userReactions[momentId].push(emoji);
                                        localStorage.setItem('userReactions', JSON.stringify(userReactions));
                                        
                                        showToast(`You reacted with ${emoji}`);
                                    } else {
                                        showToast(`You've already used this reaction`);
                                    }
                                    // Don't remove the picker so user can add multiple different reactions
                                    event.stopPropagation();
                                });
                                picker.appendChild(emojiBtn);
                            });
                            
                            // Add a close button
                            const closeBtn = document.createElement('button');
                            closeBtn.className = 'text-sm hover:scale-125 transition-transform ml-1 bg-red-800 rounded-full w-5 h-5 flex items-center justify-center';
                            closeBtn.innerHTML = '×';
                            closeBtn.addEventListener('click', () => {
                                picker.remove();
                            });
                            picker.appendChild(closeBtn);
                            
                            button.parentElement.style.position = 'relative';
                            button.parentElement.appendChild(picker);
                            
                            setTimeout(() => {
                                const closePicker = (e) => {
                                    if (!picker.contains(e.target) && e.target !== button) {
                                        picker.remove();
                                        document.removeEventListener('click', closePicker);
                                    }
                                };
                                document.addEventListener('click', closePicker);
                            }, 0);
                        });
                    });
                    
                    popupContent.querySelectorAll('.moment-hide').forEach(button => {
                        button.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const momentId = button.getAttribute('data-moment-id');
                            const messageElement = popupContent.querySelector('.hidden-message, [class*="text-white"]:not(.hidden-message)');
                            
                            if (revealedMessages[momentId]) {
                                delete revealedMessages[momentId];
                                localStorage.setItem('revealedMessages', JSON.stringify(revealedMessages));
                                
                                if (messageElement) {
                                    messageElement.classList.add('hidden-message');
                                    messageElement.textContent = 'This message is hidden. Click to reveal.';
                                }
                                
                                button.innerHTML = '<i class="far fa-eye"></i>';
                                showToast('Message hidden');
                            } else {
                                revealedMessages[momentId] = true;
                                localStorage.setItem('revealedMessages', JSON.stringify(revealedMessages));
                                
                                if (messageElement) {
                                    messageElement.classList.remove('hidden-message');
                                    const moment = moments.find(m => m.id === momentId);
                                    if (moment) {
                                        messageElement.textContent = moment.message;
                                    }
                                }
                                
                                button.innerHTML = '<i class="far fa-eye-slash"></i>';
                                showToast('Message revealed');
                            }
                        });
                    });
                    
                    popupContent.querySelectorAll('.moment-delete').forEach(button => {
                        button.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const momentId = button.getAttribute('data-moment-id');
                            
                            if (confirm('Are you sure you want to delete this moment?')) {
                                if (db && doc && deleteDoc) {
                                    const docRef = doc(db, 'moments', momentId);
                                    deleteDoc(docRef).then(() => {
                                        showToast('Moment deleted');
                                        map.closePopup();
                                    }).catch(error => {
                                        console.error("Error deleting moment:", error);
                                        showToast('Error deleting moment');
                                    });
                                } else {
                                    console.error("Firebase functions not initialized for delete");
                                }
                            }
                        });
                    });
                    
                    popupContent.querySelectorAll('.reply-button').forEach(button => {
                        button.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const momentId = button.getAttribute('data-moment-id');
                            const input = popupContent.querySelector(`.reply-input[data-moment-id="${momentId}"]`);
                            const message = input.value.trim();
                            
                            if (message) {
                                addReply(momentId, message);
                                input.value = '';
                                showToast('Reply added');
                                
                                // Don't close the popup
                                setTimeout(() => {
                                    const repliesContainer = document.getElementById(`replies-${momentId}`);
                                    if (repliesContainer) {
                                        const newReply = document.createElement('div');
                                        newReply.className = 'reply';
                                        newReply.innerHTML = `
                                            <div class="flex items-center justify-between">
                                                <span class="font-medium">${userId}</span>
                                                <span class="text-gray-400 text-xs">Just now</span>
                                            </div>
                                            <div>${message}</div>
                                        `;
                                        repliesContainer.appendChild(newReply);
                                    }
                                }, 100);
                            }
                        });
                    });
                    
                    popupContent.querySelectorAll('.reply-input').forEach(input => {
                        input.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                e.stopPropagation();
                                e.preventDefault();
                                const momentId = input.getAttribute('data-moment-id');
                                const message = input.value.trim();
                                
                                if (message) {
                                    addReply(momentId, message);
                                    input.value = '';
                                    showToast('Reply added');
                                    
                                    // Add reply to UI immediately for better UX
                                    setTimeout(() => {
                                        const repliesContainer = document.getElementById(`replies-${momentId}`);
                                        if (repliesContainer) {
                                            const newReply = document.createElement('div');
                                            newReply.className = 'reply';
                                            newReply.innerHTML = `
                                                <div class="flex items-center justify-between">
                                                    <span class="font-medium">${userId}</span>
                                                    <span class="text-gray-400 text-xs">Just now</span>
                                                </div>
                                                <div>${message}</div>
                                            `;
                                            repliesContainer.appendChild(newReply);
                                        }
                                    }, 100);
                                }
                            }
                        });
                    });
                    
                    markers.push(marker);
                }
            });
            
            // Update the feed with current moments
            updateFeed();
        }
        
        // Function to update the feed panel with recent moments
        function updateFeed() {
            if (!feedItems) return;
            
            feedItems.innerHTML = '';
            
            // Sort by timestamp, most recent first
            const sortedMoments = [...moments].sort((a, b) => b.timestamp - a.timestamp);
            
            if (sortedMoments.length === 0) {
                feedItems.innerHTML = '<p class="text-center text-gray-500 my-4">No moments shared yet</p>';
                return;
            }
            
            sortedMoments.forEach(moment => {
                const feedItem = document.createElement('div');
                feedItem.className = 'feed-item';
                feedItem.dataset.id = moment.id;
                feedItem.dataset.lat = moment.coords?.lat;
                feedItem.dataset.lng = moment.coords?.lng;
                
                const isHidden = moment.isHidden && !revealedMessages[moment.id];
                
                feedItem.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center">
                            <span class="text-2xl mr-2">${moment.mood}</span>
                            <span class="text-sm text-gray-400">${getTimeAgo(moment.timestamp)}</span>
                        </div>
                        ${moment.location ? 
                            `<span class="text-xs bg-gray-800 px-2 py-1 rounded-full">
                                <i class="fas fa-map-marker-alt mr-1"></i>${moment.location}
                             </span>` : ''}
                    </div>
                    <div class="mb-2 ${isHidden ? 'hidden-message' : ''} text-sm">
                        ${isHidden ? 'This message is hidden. Click to reveal.' : moment.message}
                    </div>
                    <div class="flex justify-between text-xs text-gray-400">
                        <div>
                            ${Object.keys(moment.reactions || {}).length > 0 ? 
                                `<span><i class="far fa-smile mr-1"></i>${
                                    Object.entries(moment.reactions).map(([emoji, count]) => `${emoji} ${count}`).join(' ')
                                }</span>` : 
                                '<span><i class="far fa-smile mr-1"></i>No reactions</span>'}
                        </div>
                        <div>
                            <i class="far fa-comment-alt mr-1"></i>${moment.replies ? moment.replies.length : 0} replies
                        </div>
                    </div>
                `;
                
                // When clicking on a feed item, fly to its location and open its popup
                feedItem.addEventListener('click', () => {
                    const lat = parseFloat(feedItem.dataset.lat);
                    const lng = parseFloat(feedItem.dataset.lng);
                    
                    if (!isNaN(lat) && !isNaN(lng)) {
                        map.flyTo([lat, lng], 14);
                        
                        // Find the marker and open its popup
                        const marker = markers.find(m => {
                            const latLng = m.getLatLng();
                            return Math.abs(latLng.lat - lat) < 0.0001 && Math.abs(latLng.lng - lng) < 0.0001;
                        });
                        
                        if (marker) {
                            setTimeout(() => {
                                marker.openPopup();
                            }, 1000); // Wait for the map to fly to location
                        }
                        
                        // On mobile, close the feed panel after selection
                        if (window.innerWidth < 768) {
                            toggleFeed();
                        }
                    }
                });
                
                feedItems.appendChild(feedItem);
            });
        }
        
        // Toggle feed visibility
        function toggleFeed() {
            isFeedOpen = !isFeedOpen;
            
            if (isFeedOpen) {
                feedPanel.classList.add('active');
                feedToggle.innerHTML = '<i class="fas fa-times"></i>';
                // On larger screens, adjust map container
                if (window.innerWidth >= 768) {
                    mapContainer.classList.add('feed-active');
                    if (floatingForm) {
                        floatingForm.classList.add('feed-active');
                    }
                }
            } else {
                feedPanel.classList.remove('active');
                feedToggle.innerHTML = '<i class="fas fa-list"></i>';
                mapContainer.classList.remove('feed-active');
                if (floatingForm) {
                    floatingForm.classList.remove('feed-active');
                }
            }
            
            // Need to update the map size when changing container dimensions
            setTimeout(() => {
                map.invalidateSize();
            }, 300);
        }
        
        // Add feed toggle event listener
        if (feedToggle) {
            feedToggle.addEventListener('click', toggleFeed);
        }
        
        // Fix for the toggle form button to ensure it shows/hides the form properly
        if (toggleFormButton && closeFormButton && floatingForm) {
            toggleFormButton.addEventListener('click', () => {
                isFormOpen = !isFormOpen;
                
                if (isFormOpen) {
                    floatingForm.classList.remove('hidden');
                    toggleFormButton.innerHTML = '<i class="fas fa-minus"></i>';
                } else {
                    floatingForm.classList.add('hidden');
                    toggleFormButton.innerHTML = '<i class="fas fa-plus"></i>';
                }
            });
            
            closeFormButton.addEventListener('click', () => {
                floatingForm.classList.add('hidden');
                toggleFormButton.innerHTML = '<i class="fas fa-plus"></i>';
                isFormOpen = false;
            });
        }
        
        moodToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            emojiPicker.classList.toggle('show');
        });
        
        document.addEventListener('click', () => {
            emojiPicker.classList.remove('show');
        });
        
        emojiPicker.addEventListener('click', (e) => {
            if (e.target.classList.contains('emoji-option') || e.target.parentElement.classList.contains('emoji-option')) {
                const emoji = e.target.getAttribute('data-emoji') || e.target.parentElement.getAttribute('data-emoji');
                document.getElementById('selected-mood').textContent = emoji;
                emojiPicker.classList.remove('show');
            }
        });
        
        messageInput.addEventListener('input', () => {
            charCount.textContent = messageInput.value.length;
        });
        
        momentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!momentsRef) {
                showToast('Please wait, connecting to database...');
                return;
            }
            
            const message = messageInput.value.trim();
            const location = locationInput.value.trim();
            const mood = document.getElementById('selected-mood').textContent;
            const isHidden = hideMessageCheckbox.checked;
            
            if (!message) return;
            
            let coords = null;
            if (location) {
                coords = await getCoordinates(location);
            } else if (userGeoLocation) {
                coords = userGeoLocation;
            } else if (userLocation?.coords) {
                coords = userLocation.coords;
            }
            
            const newMoment = {
                id: Date.now().toString(),
                message,
                location,
                mood,
                coords,
                isHidden,
                reactions: {},
                replies: [],
                timestamp: Date.now(),
                userId
            };
            
            saveMoment(newMoment);
            
            messageInput.value = '';
            locationInput.value = '';
            charCount.textContent = '0';
            hideMessageCheckbox.checked = false;
            
            showToast('Moment shared with the world');
            
            if (floatingForm) {
                floatingForm.classList.add('hidden');
                toggleFormButton.innerHTML = '<i class="fas fa-plus"></i>';
                isFormOpen = false;
            }
        });
        
        async function getCoordinates(location) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
                
                const cities = {
                    "new york": { lat: 40.7128, lng: -74.0060 },
                    "london": { lat: 51.5074, lng: -0.1278 },
                    "tokyo": { lat: 35.6762, lng: 139.6503 },
                    "berlin": { lat: 52.5200, lng: 13.4050 },
                    "paris": { lat: 48.8566, lng: 2.3522 },
                    "sydney": { lat: -33.8688, lng: 151.2093 },
                    "san francisco": { lat: 37.7749, lng: -122.4194 },
                    "mumbai": { lat: 19.0760, lng: 72.8777 },
                    "default": { 
                        lat: Math.random() * 180 - 90, 
                        lng: Math.random() * 360 - 180 
                    }
                };
                
                const normalizedLocation = location.toLowerCase();
                for (const city in cities) {
                    if (normalizedLocation.includes(city)) {
                        return cities[city];
                    }
                }
                
                return cities.default;
            } catch (error) {
                console.error("Error getting coordinates:", error);
                return {
                    lat: Math.random() * 180 - 90, 
                    lng: Math.random() * 360 - 180 
                };
            }
        }
        
        function saveMoment(moment) {
            if (!db || !setDoc || !doc) {
                console.error("Firebase not initialized yet");
                return;
            }
            const docRef = doc(db, 'moments', moment.id);
            setDoc(docRef, moment);
        }
        
        function addReaction(momentId, emoji) {
            if (!db || !updateDoc || !doc) {
                console.error("Firebase not initialized yet");
                return;
            }
            
            const momentDocRef = doc(db, 'moments', momentId);
            
            getDoc(momentDocRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.data();
                    const reactions = data.reactions || {};
                    reactions[emoji] = (reactions[emoji] || 0) + 1;
                    
                    updateDoc(momentDocRef, {
                        reactions: reactions
                    });
                }
            }).catch(error => {
                console.error("Error updating reaction:", error);
            });
        }
        
        function addReply(momentId, message) {
            if (!db || !updateDoc || !doc) {
                console.error("Firebase not initialized yet");
                return;
            }
            
            const momentDocRef = doc(db, 'moments', momentId);
            
            getDoc(momentDocRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.data();
                    const replies = data.replies || [];
                    
                    replies.push({
                        userId: userId,
                        message: message,
                        timestamp: Date.now()
                    });
                    
                    updateDoc(momentDocRef, {
                        replies: replies
                    });
                }
            }).catch(error => {
                console.error("Error adding reply:", error);
            });
        }
        
        function loadMoments() {
            if (!db || !collection || !onSnapshot) {
                console.error("Firebase functions not initialized yet for loadMoments");
                return;
            }
            
            const momentsCollection = collection(db, 'moments');
            onSnapshot(momentsCollection, (snapshot) => {
                const allMoments = [];
                snapshot.forEach((doc) => {
                    allMoments.push(doc.data());
                });
                
                const sixHoursAgo = Date.now() - 6 * 60 * 60 * 1000;
                const recentMoments = allMoments.filter(m => m.timestamp > sixHoursAgo);
                
                recentMoments.sort((a, b) => b.timestamp - a.timestamp);
                
                moments = recentMoments;
                updateMapMarkers();
                // Also update the feed whenever moments change
                updateFeed();
            });
        }
        
        function cleanupOldMoments() {
            if (!db || !collection || !doc || !deleteDoc || !getDocs) {
                console.error("Firebase functions not initialized yet for cleanupOldMoments");
                return;
            }
            
            const sixHoursAgo = Date.now() - 6 * 60 * 60 * 1000;
            const momentsCollection = collection(db, 'moments');
            
            getDocs(momentsCollection).then((snapshot) => {
                snapshot.forEach((document) => {
                    const data = document.data();
                    if (data.timestamp < sixHoursAgo) {
                        deleteDoc(doc(db, 'moments', data.id));
                    }
                });
            }).catch(error => {
                console.error("Error cleaning up old moments:", error);
            });
        }
        
        function getTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            
            let interval = Math.floor(seconds / 31536000);
            if (interval >= 1) return `${interval}y ago`;
            
            interval = Math.floor(seconds / 2592000);
            if (interval >= 1) return `${interval}mo ago`;
            
            interval = Math.floor(seconds / 86400);
            if (interval >= 1) return `${interval}d ago`;
            
            interval = Math.floor(seconds / 3600);
            if (interval >= 1) return `${interval}h ago`;
            
            interval = Math.floor(seconds / 60);
            if (interval >= 1) return `${interval}m ago`;
            
            return 'Just now';
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <i class="fas fa-check-circle text-green-400"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }
        
        themeToggle.addEventListener('click', () => {
            if (isDarkMode) {
                map.removeLayer(darkTile);
                lightTile.addTo(map);
                document.documentElement.classList.remove('dark');
                document.documentElement.classList.add('light');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                showToast('Light mode activated');
            } else {
                map.removeLayer(lightTile);
                darkTile.addTo(map);
                document.documentElement.classList.remove('light');
                document.documentElement.classList.add('dark');
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                showToast('Dark mode activated');
            }
            isDarkMode = !isDarkMode;
        });
        
        function generateDemoMoments() {
            const demoLocations = [
                "Tokyo", "New York", "London", "Berlin", "Paris", 
                "Sydney", "San Francisco", "Mumbai", "Rio de Janeiro", "Cape Town"
            ];
            const demoMessages = [
                "Watching the sunrise with a cup of coffee",
                "Listening to the rain against my window",
                "People watching at the train station",
                "Reading in a quiet corner of the library",
                "The hum of the city at night",
                "First snow of the year falling gently",
                "Street musician playing my favorite song",
                "The smell of fresh bread from the bakery",
                "Golden hour light through the trees",
                "Quiet moment before the day begins"
            ];
            const demoMoods = ["😊", "☕", "🎧", "📚", "🌞", "🍂", "❄️", "🎶", "🍞", "🌅"];
            const demoReactions = {
                "❤️": 3,
                "😂": 2,
                "😮": 1,
                "👍": 4
            };
            
            for (let i = 0; i < 10; i++) {
                const timestamp = Date.now() - Math.random() * 6 * 60 * 60 * 1000;
                const location = demoLocations[Math.floor(Math.random() * demoLocations.length)];
                
                getCoordinates(location).then(coords => {
                    const moment = {
                        id: timestamp.toString(),
                        message: demoMessages[Math.floor(Math.random() * demoMessages.length)],
                        location: location,
                        mood: demoMoods[Math.floor(Math.random() * demoMoods.length)],
                        coords: coords,
                        isHidden: Math.random() > 0.8,
                        reactions: Math.random() > 0.3 ? demoReactions : {},
                        replies: Math.random() > 0.5 ? [{
                            userId: 'demo-user',
                            message: "This is a sample reply",
                            timestamp: timestamp + 1000 * 60 * 30
                        }] : [],
                        timestamp: timestamp,
                        userId: 'demo-user'
                    };
                    
                    saveMoment(moment);
                });
            }
        }
        
        initMap();
    </script>
</body>
</html>
